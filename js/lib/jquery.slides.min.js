(function($) {
	$.fn.slides = function(options) {
		var $this = this;
		var settings = {
			'width' : this.width(),
			'height' : this.height(),
			'wait' : 4000,
			'fade' : 750,
			'direction' : 'left',
			'showControls' : true,
			'showProgress' : true,
			'hoverPause' : true,
			'autoplay' : true,
			'randomize' : false,
			'slidebefore' : function() {
			},
			'slideafter' : function() {
			},
			'rewind' : function() {
			}
		};
		var _timer = false;
		var _last = false;
		var _this = false;
		var _cycle = function() {
			clearTimeout(_timer);
			_last = _this;
			if (settings.direction == 'right') {
				_this = _this.prev('.jquery-slides-element');
			} else {
				_this = _this.next('.jquery-slides-element');
			}
			if (!_this.length) {
				_rewind();
			}
			_draw();
			if (!$this.hasClass('jquery-slides-paused') && settings.autoplay) {
				_timer = setTimeout(_cycle, settings.wait);
			}
		};
		var _rewind = function() {
			if (settings.direction == 'right') {
				_this = $this.children('.jquery-slides-element').last();
			} else {
				_this = $this.children('.jquery-slides-element').first();
			}
			settings.rewind(_this, $this);
		};
		var _draw = function() {
			$this.addClass('jquery-slides-sliding');
			if (settings.showProgress) {
				$this.find('.jquery-slides-page').removeClass(
						'jquery-slides-page-current');
				$this
						.find(
								'.jquery-slides-page:eq('
										+ (_this
												.nextAll('.jquery-slides-element').length)
										+ ')').addClass(
								'jquery-slides-page-current');
			}
			settings.slidebefore(_this, $this);
			if (settings.direction == 'right') {
				_this.show().css('left', -settings.width);
			} else {
				_this.show().css('left', settings.width);
			}
			_this.stop(true, true).animate(
					{
						'left' : (settings.direction == 'right' ? '+=' : '-=')
								+ settings.width + 'px'
					}, {
						'duration' : settings.fade,
						'complete' : function() {
							settings.slideafter(_this, $this);
							$this.removeClass('jquery-slides-sliding');
						}
					});
			if (_last) {
				_last.stop(true, true).animate(
						{
							'left' : (settings.direction == 'right' ? '+='
									: '-=')
									+ settings.width + 'px'
						}, {
							'duration' : settings.fade
						});
			}
		};
		var _next = function() {
			if ($this.hasClass('jquery-slides-sliding'))
				return;
			var direction = settings.direction;
			$this.addClass('jquery-slides-paused');
			settings.direction = 'left';
			_cycle();
			settings.direction = direction;
		};
		var _prev = function() {
			if ($this.hasClass('jquery-slides-sliding'))
				return;
			var direction = settings.direction;
			$this.addClass('jquery-slides-paused');
			settings.direction = 'right';
			_cycle();
			settings.direction = direction;
		};
		var _show = function(id, count){
			if(!count){//how many times can we slide?
				count = _this.parent().find('.jquery-slides-element').length; 
			}else if(count == 0){//we've slided all
				return;
			}
			var _id = _this.attr('id');
			if(_id === id){ //if this slide has the specified id
				return;
			}

			_next(); // next slide
			setTimeout(function(){_show(id, --count);}, settings.fade);
		};
		this.show = _show;
		var _init = function() {
			if (options) {
				$.extend(settings, options);
			}
			if (settings.hoverPause) {
				$this.bind({
					'mouseenter' : function() {
						$this.addClass('jquery-slides-paused')
						clearTimeout(_timer);
					},
					'mouseleave' : function() {
						$this.removeClass('jquery-slides-paused');
						if (settings.autoplay) {
							_timer = setTimeout(_cycle, settings.wait);
						}
					}
				});
			}
			var positionEls = $('<span class="jquery-slides-pages"></span>');
			$this.addClass('jquery-slides').width(settings.width).height(
					settings.height);
			$this
					.children()
					.each(
							function() {
								var $tmp = $(this);
								_this = $(this).addClass(
										'jquery-slides-element');
								positionEls
										.prepend($(
												'<span class="jquery-slides-page"></span>')
												.bind(
														'click',
														function() {
															if ($this
																	.hasClass('jquery-slides-sliding'))
																return;
															_last = _this;
															_this = $tmp;
															_draw();
														}));
							});
			if (settings.showProgress) {
				$this.append(positionEls);
			}
			if (settings.showControls) {
				var controlPrev = $(
						'<span class="jquery-slides-control jquery-slides-control-prev">&laquo;</span>')
						.bind('click', function() {
							_prev();
						});
				var controlNext = $(
						'<span class="jquery-slides-control jquery-slides-control-next">&raquo;</span>')
						.bind('click', function() {
							_next();
						});
				$this.append(controlPrev);
				$this.append(controlNext);
			}
			if (settings.randomize) {
				_this = $this
						.children('.jquery-slides-element')
						.eq(
								parseInt($this
										.children('.jquery-slides-element').length
										* Math.random()));
			}
			_cycle();
		};
		this.init = _init;

		_init();
		return this;
	};
})(jQuery);